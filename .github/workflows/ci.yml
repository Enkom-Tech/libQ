name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Core validation pipeline - runs first and fastest
  core-validation:
    name: Core Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      cache-key: ${{ steps.cache-key.outputs.value }}
    steps:
      - uses: actions/checkout@v5
      
      - name: Generate cache key
        id: cache-key
        run: echo "value=${{ github.sha }}-${{ github.run_id }}" >> $GITHUB_OUTPUT
      
      - name: Core validation
        uses: ./.github/actions/rust-build
        with:
          run-security-audit: "true"
          run-format-check: "true"
          run-clippy: "true"
          run-tests: "false"
          features: "all-algorithms"

  # Parallel test matrix - runs after core validation
  test-matrix:
    name: Test Matrix
    needs: core-validation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        include:
          - name: "std"
            features: "std"
            package: ""
          - name: "all-algorithms"
            features: "std,all-algorithms"
            package: ""
          - name: "ml-kem"
            features: "std,ml-kem,rand"
            package: ""
          - name: "no_std"
            features: "no_std,getrandom"
            package: ""
          - name: "wasm"
            features: "std,wasm"
            package: ""
          - name: "zkp"
            features: "std,zkp"
            package: ""
          - name: "lib-q-kem"
            features: "ml-kem"
            package: "lib-q-kem"
          - name: "lib-q-ml-kem"
            features: "std"
            package: "lib-q-ml-kem"
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Run tests
        uses: ./.github/actions/rust-test
        with:
          features: ${{ matrix.features }}
          package: ${{ matrix.package }}
          run-release-tests: "true"

  # WASM validation - parallel with test matrix
  wasm-validation:
    name: WASM Validation
    needs: core-validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        include:
          - working-directory: "."
            features: "wasm,all-algorithms,ml-kem"
          - working-directory: "lib-q-kem"
            features: "wasm,ml-kem"
          - working-directory: "lib-q-core"
            features: "wasm,ml-kem,rand"
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Build WASM
        uses: ./.github/actions/wasm-build
        with:
          working-directory: ${{ matrix.working-directory }}
          features: ${{ matrix.features }}
          targets: "web,nodejs"

  # Cross-platform builds - parallel execution
  cross-platform:
    name: Cross-Platform Builds
    needs: core-validation
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: "Linux x86_64"
            install-cross-compiler: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            name: "Linux ARM64"
            install-cross-compiler: true
            cross-compiler-packages: "gcc-aarch64-linux-gnu"
          - os: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            name: "Linux ARMv7"
            install-cross-compiler: true
            cross-compiler-packages: "gcc-arm-linux-gnueabihf"
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: "Windows x86_64"
            install-cross-compiler: false
          - os: macos-latest
            target: x86_64-apple-darwin
            name: "macOS x86_64"
            install-cross-compiler: false
          - os: macos-latest
            target: aarch64-apple-darwin
            name: "macOS ARM64"
            install-cross-compiler: false

    steps:
      - uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install cross-compiler toolchains (Ubuntu)
        if: matrix.install-cross-compiler && runner.os == 'Linux'
        run: |
          echo "Installing cross-compiler toolchain for ${{ matrix.name }}"
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.cross-compiler-packages }}

          # Install additional dependencies for cross-compilation
          if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libc6-dev-arm64-cross
          elif [[ "${{ matrix.target }}" == "armv7-unknown-linux-gnueabihf" ]]; then
            sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf libc6-dev-armhf-cross
          fi

          # Verify installation - check different possible command names
          if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
            echo "Verifying aarch64-linux-gnu-gcc installation..."
            if command -v aarch64-linux-gnu-gcc &> /dev/null; then
              aarch64-linux-gnu-gcc --version
              echo "✅ aarch64-linux-gnu-gcc found and working"
            else
              echo "❌ aarch64-linux-gnu-gcc not found in PATH"
              echo "Available gcc commands:"
              ls -la /usr/bin/*aarch64* 2>/dev/null || echo "No aarch64 commands found"
              exit 1
            fi
          elif [[ "${{ matrix.target }}" == "armv7-unknown-linux-gnueabihf" ]]; then
            echo "Verifying arm-linux-gnueabihf-gcc installation..."
            if command -v arm-linux-gnueabihf-gcc &> /dev/null; then
              arm-linux-gnueabihf-gcc --version
              echo "✅ arm-linux-gnueabihf-gcc found and working"
            else
              echo "❌ arm-linux-gnueabihf-gcc not found in PATH"
              echo "Available gcc commands:"
              ls -la /usr/bin/*arm* 2>/dev/null || echo "No arm commands found"
              exit 1
            fi
          fi
          echo "✅ Cross-compiler toolchain verified"

      - name: Add target
        run: rustup target add ${{ matrix.target }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-

      - name: Build for target
        run: |
          echo "Building for ${{ matrix.name }} (${{ matrix.target }})"
          # Build with security-focused flags
          RUSTFLAGS="-C target-cpu=generic -C opt-level=3 -C overflow-checks=on" \
          cargo build --target ${{ matrix.target }} --features "all-algorithms" --release

      - name: Verify cross-compilation integrity
        if: matrix.install-cross-compiler
        run: |
          echo "Verifying cross-compilation integrity for ${{ matrix.name }}"
          # Check that the binary was compiled for the correct architecture
          if [[ "${{ matrix.target }}" == aarch64-* ]]; then
            file target/${{ matrix.target }}/release/liblib_q_keccak.so | grep -q "ARM aarch64" || (echo "Architecture mismatch detected!" && exit 1)
          elif [[ "${{ matrix.target }}" == armv7-* ]]; then
            file target/${{ matrix.target }}/release/liblib_q_keccak.so | grep -q "ARM" || (echo "Architecture mismatch detected!" && exit 1)
          fi
          echo "✅ Cross-compilation integrity verified"

      - name: Run cross-compilation tests
        if: matrix.install-cross-compiler && matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          echo "Running cross-compilation validation tests for ${{ matrix.name }}"
          cd lib-q-keccak
          # Run the cross-compilation test script
          chmod +x cross_compile_test.sh
          ./cross_compile_test.sh
          # Run the new cross-compilation unit tests
          cargo test --target ${{ matrix.target }} --features std cross_compilation --release --verbose
          echo "✅ Cross-compilation tests passed"

  # Performance and benchmarks - runs after core validation
  performance:
    name: Performance & Benchmarks
    needs: core-validation
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v5
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-bench-
      
      - name: Run benchmarks
        run: cargo bench --features "all-algorithms" --verbose

  # Documentation generation - lightweight job
  documentation:
    name: Documentation
    needs: core-validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-docs-
      
      - name: Generate documentation
        run: |
          cargo doc --all-features --no-deps
          cargo doc --all-features --no-deps --document-private-items

  # Specialized algorithm testing - parallel execution
  algorithm-tests:
    name: Algorithm Tests
    needs: core-validation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        include:
          - name: "Keccak"
            action: test-keccak
            working-directory: lib-q-keccak
            features: "asm,simd"
            rust-version: "nightly"
            run-benchmarks: "true"
            test-algorithms: ""
          - name: "SHA3"
            action: test-sha3
            working-directory: lib-q-sha3
            features: "alloc,oid"
            rust-version: "stable"
            test-algorithms: "sha3-224,sha3-256,sha3-384,sha3-512,keccak224,keccak256,keccak384,keccak512"
            run-benchmarks: "false"
          - name: "K12"
            action: test-k12
            working-directory: lib-q-k12
            features: "alloc,oid"
            rust-version: "stable"
            run-benchmarks: "false"
            test-algorithms: ""
          - name: "Ascon"
            action: test-ascon
            working-directory: lib-q-ascon
            features: ""
            rust-version: "stable"
            run-benchmarks: "false"
            test-algorithms: ""
          - name: "Sponge"
            action: test-lib-q-sponge
            working-directory: lib-q-sponge
            features: "asm"
            rust-version: "stable"
            run-benchmarks: "false"
            test-algorithms: ""
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Run algorithm tests
        uses: ./.github/actions/test-keccak
        if: matrix.action == 'test-keccak'
        with:
          working-directory: ${{ matrix.working-directory }}
          features: ${{ matrix.features }}
          rust-version: ${{ matrix.rust-version }}
          run-benchmarks: ${{ matrix.run-benchmarks }}
          test-algorithms: ${{ matrix.test-algorithms }}
      
      - name: Run SHA3 tests
        uses: ./.github/actions/test-sha3
        if: matrix.action == 'test-sha3'
        with:
          working-directory: ${{ matrix.working-directory }}
          features: ${{ matrix.features }}
          rust-version: ${{ matrix.rust-version }}
          run-benchmarks: ${{ matrix.run-benchmarks }}
          test-algorithms: ${{ matrix.test-algorithms }}
      
      - name: Run K12 tests
        uses: ./.github/actions/test-k12
        if: matrix.action == 'test-k12'
        with:
          working-directory: ${{ matrix.working-directory }}
          features: ${{ matrix.features }}
          rust-version: ${{ matrix.rust-version }}
          run-benchmarks: ${{ matrix.run-benchmarks }}
          test-algorithms: ${{ matrix.test-algorithms }}
      
      - name: Run Ascon tests
        uses: ./.github/actions/test-ascon
        if: matrix.action == 'test-ascon'
        with:
          working-directory: ${{ matrix.working-directory }}
          features: ${{ matrix.features }}
          rust-version: ${{ matrix.rust-version }}
          run-benchmarks: ${{ matrix.run-benchmarks }}
          test-algorithms: ${{ matrix.test-algorithms }}
      
      - name: Run Sponge tests
        uses: ./.github/actions/test-lib-q-sponge
        if: matrix.action == 'test-lib-q-sponge'
        with:
          working-directory: ${{ matrix.working-directory }}
          features: ${{ matrix.features }}
          rust-version: ${{ matrix.rust-version }}
          run-benchmarks: ${{ matrix.run-benchmarks }}
          test-algorithms: ${{ matrix.test-algorithms }}

  # ML-KEM specific testing
  ml-kem-tests:
    name: ML-KEM Tests
    needs: core-validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v5
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-mlkem-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-mlkem-
      
      - name: Test ML-KEM standalone
        run: |
          cd lib-q-ml-kem
          cargo test --verbose
      
      - name: Test ML-KEM integration
        run: |
          cd lib-q-core
          cargo test --features "ml-kem,rand" --verbose
          cargo build --no-default-features --features "getrandom"
      
      - name: Test ML-KEM with lib-q-kem
        run: |
          cd lib-q-kem
          cargo test --features "ml-kem" --verbose

  # Constant-time verification - critical for crypto
  constant-time:
    name: Constant-Time Verification
    needs: core-validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v5
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      
      - name: Install valgrind
        run: |
          sudo apt-get update
          sudo apt-get install -y valgrind
      
      - name: Install cargo-valgrind
        run: cargo install cargo-valgrind
      
      - name: Run constant-time tests
        run: |
          echo "Running constant-time tests for lib-q-sha3..."
          cargo test --test constant_time -p lib-q-sha3
          echo "Running constant-time tests for lib-q-ascon..."
          cargo test --test constant_time -p lib-q-ascon
          echo "Running constant-time tests for lib-q-k12..."
          cargo test --test constant_time -p lib-q-k12

  # Final validation - runs after all other jobs
  final-validation:
    name: Final Validation
    needs: [test-matrix, wasm-validation, cross-platform, performance, documentation, algorithm-tests, ml-kem-tests, constant-time]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check job status
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "All jobs completed. Check individual job results above." >> $GITHUB_STEP_SUMMARY
          
          # Check if any required jobs failed
          if [[ "${{ needs.test-matrix.result }}" == "failure" ]] || \
             [[ "${{ needs.wasm-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.constant-time.result }}" == "failure" ]]; then
            echo "❌ Critical jobs failed. Please review the failures above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "✅ All critical jobs passed successfully!" >> $GITHUB_STEP_SUMMARY


